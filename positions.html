  <!DOCTYPE html>
  <html lang="zh-CN">
    <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>Position Management - Financial Management System</title>
      <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script src="./i18n.js"></script>
      <style>
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
          font-family: 'Segoe UI', 'Roboto', 'Arial', sans-serif;
        }

        :root {
          --primary: #2563eb;
          --primary-light: #3b82f6;
          --success: #10b981;
          --danger: #ef4444;
          --warning: #f59e0b;
          --dark: #1e293b;
          --darker: #0f172a;
          --light: #f8fafc;
          --gray: #94a3b8;
          --border: #e2e8f0;
          --card-bg: #ffffff;
          --header-bg: #ffffff;
          --body-bg: #f1f5f9;
          --chart-gradient: linear-gradient(
            90deg,
            rgba(37, 99, 235, 0.1),
            rgba(59, 130, 246, 0.05)
          );
        }

        body {
          background-color: var(--body-bg);
          color: var(--dark);
          line-height: 1.6;
        }

        .container {
          max-width: 1400px;
          margin: 0 auto;
          padding: 20px;
        }

        header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 30px;
          padding-bottom: 15px;
          border-bottom: 1px solid var(--border);
          background-color: var(--header-bg);
          border-radius: 12px;
          padding: 20px;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .logo {
          display: flex;
          align-items: center;
          gap: 12px;
        }

        .logo i {
          color: var(--primary);
          font-size: 28px;
        }

        .logo h1 {
          font-size: 24px;
          font-weight: 700;
          color: var(--darker);
        }

        .nav-tabs {
          display: flex;
          gap: 15px;
          list-style: none;
        }

        .nav-tabs li a {
          color: var(--gray);
          text-decoration: none;
          font-weight: 500;
          padding: 8px 16px;
          border-radius: 20px;
          transition: all 0.3s ease;
          font-size: 15px;
        }

        .nav-tabs li a.active,
        .nav-tabs li a:hover {
          background-color: rgba(37, 99, 235, 0.08);
          color: var(--primary);
        }

        .panel {
          background-color: var(--card-bg);
          border-radius: 16px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
          padding: 25px;
          margin-bottom: 25px;
        }

        .panel-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 25px;
        }

        .panel-title {
          font-size: 20px;
          font-weight: 600;
          color: var(--darker);
        }

        .panel-actions {
          display: flex;
          gap: 10px;
        }

        .btn {
          padding: 8px 16px;
          border-radius: 8px;
          border: none;
          cursor: pointer;
          font-weight: 500;
          font-size: 14px;
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          gap: 6px;
        }

        .btn-primary {
          background-color: var(--primary);
          color: white;
        }

        .btn-primary:hover {
          background-color: var(--primary-light);
        }

        .btn-outline {
          background-color: transparent;
          border: 1px solid var(--border);
          color: var(--dark);
        }

        .btn-outline:hover {
          background-color: var(--light);
        }

        .summary-cards {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
        }

        .summary-card {
          background: var(--card-bg);
          border-radius: 12px;
          padding: 20px;
          border: 1px solid var(--border);
          transition: all 0.3s ease;
        }

        .summary-card:hover {
          box-shadow: 0 6px 12px rgba(0, 0, 0, 0.07);
          transform: translateY(-3px);
        }

        .summary-card-title {
          font-size: 15px;
          color: var(--gray);
          margin-bottom: 10px;
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .summary-card-value {
          font-size: 26px;
          font-weight: 700;
          margin-bottom: 6px;
        }

        .summary-card-info {
          font-size: 14px;
          color: var(--gray);
          display: flex;
          align-items: center;
          gap: 6px;
        }

        .positive {
          color: var(--success);
        }

        .negative {
          color: var(--danger);
        }

        .chart-container {
          height: 300px;
          margin: 25px 0;
          background-color: var(--light);
          border-radius: 12px;
          padding: 15px;
          background-image: var(--chart-gradient);
        }

        .data-section {
          background-color: var(--card-bg);
          border-radius: 12px;
          padding: 25px;
          margin-top: 25px;
        }

        .data-section-title {
          font-size: 18px;
          font-weight: 600;
          color: var(--darker);
          margin-bottom: 20px;
          padding-bottom: 15px;
          border-bottom: 1px solid var(--border);
        }

        .cash-flow {
          display: flex;
          gap: 20px;
          margin-top: 25px;
        }

        .flow-card {
          flex: 1;
          background-color: var(--card-bg);
          border-radius: 12px;
          padding: 25px;
          text-align: center;
          border: 1px solid var(--border);
        }

        .flow-card.income {
          border-top: 4px solid var(--success);
        }

        .flow-card.spending {
          border-top: 4px solid var(--danger);
        }

        .flow-title {
          font-size: 17px;
          font-weight: 600;
          margin-bottom: 15px;
          color: var(--darker);
        }

        .flow-value {
          font-size: 28px;
          font-weight: 700;
          margin-bottom: 10px;
        }

        .flow-info {
          font-size: 14px;
          color: var(--gray);
        }

        .status-badge {
          padding: 4px 10px;
          border-radius: 20px;
          font-size: 12px;
          font-weight: 500;
        }

        .status-badge.positive {
          background-color: rgba(16, 185, 129, 0.1);
          color: var(--success);
        }

        .status-badge.negative {
          background-color: rgba(239, 68, 68, 0.1);
          color: var(--danger);
        }

        /* 持仓管理页面特有样式 */
        .positions-container {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 25px;
        }

        .positions-table-container {
          grid-column: span 2;
        }

        .positions-table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 20px;
        }

        .positions-table th {
          background-color: var(--primary);
          color: white;
          text-align: left;
          padding: 15px;
          font-weight: 500;
        }

        .positions-table td {
          padding: 15px;
          border-bottom: 1px solid var(--border);
        }

        .positions-table tr:nth-child(even) {
          background-color: var(--light);
        }

        .positions-table tr:hover {
          background-color: rgba(59, 130, 246, 0.05);
        }

        .position-actions {
          display: flex;
          gap: 8px;
        }

        .action-btn {
          padding: 6px 12px;
          border-radius: 4px;
          border: none;
          cursor: pointer;
          font-size: 12px;
          font-weight: 500;
        }

        .action-btn.edit {
          background-color: rgba(245, 158, 11, 0.1);
          color: var(--warning);
        }

        .action-btn.delete {
          background-color: rgba(239, 68, 68, 0.1);
          color: var(--danger);
        }

        .position-details {
          display: flex;
          align-items: center;
        }

        .position-icon {
          width: 36px;
          height: 36px;
          border-radius: 6px;
          background-color: rgba(37, 99, 235, 0.1);
          display: flex;
          align-items: center;
          justify-content: center;
          margin-right: 12px;
          color: var(--primary);
        }

        .position-name {
          font-weight: 600;
        }

        .position-ticker {
          font-size: 14px;
          color: var(--gray);
        }

        .position-change {
          font-weight: 600;
        }

        .position-change.positive {
          color: var(--success);
        }

        .position-change.negative {
          color: var(--danger);
        }

        .position-percentage {
          font-weight: 600;
          color: var(--dark);
        }

        .gainers-losers {
          grid-column: span 1;
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 15px;
        }

        .gainers-container,
        .losers-container {
          background-color: var(--card-bg);
          border-radius: 12px;
          padding: 20px;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .section-title {
          font-size: 16px;
          font-weight: 600;
          margin-bottom: 15px;
          color: var(--darker);
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .gainers-list,
        .losers-list {
          display: flex;
          flex-direction: column;
          gap: 12px;
        }

        .filter-bar {
          display: flex;
          gap: 15px;
          margin-bottom: 20px;
          padding: 15px;
          background-color: var(--card-bg);
          border-radius: 12px;
          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .filter-group {
          display: flex;
          flex-direction: column;
          gap: 6px;
        }

        .filter-group label {
          font-size: 14px;
          color: var(--gray);
        }

        .filter-group select,
        .filter-group input {
          padding: 8px 12px;
          border: 1px solid var(--border);
          border-radius: 6px;
          background-color: white;
        }

        @media (max-width: 1200px) {
          .dashboard-layout {
            grid-template-columns: 1fr;
          }

          .positions-container {
            grid-template-columns: 1fr;
          }

          .positions-table-container {
            grid-column: span 1;
          }
        }

        @media (max-width: 768px) {
          header {
            flex-direction: column;
            gap: 15px;
            padding: 15px;
          }

          .nav-tabs {
            flex-wrap: wrap;
            justify-content: center;
          }

          .summary-cards {
            grid-template-columns: 1fr;
          }

          .cash-flow {
            flex-direction: column;
          }

          .gainers-losers {
            grid-template-columns: 1fr;
          }

          .filter-bar {
            flex-direction: column;
          }
        }
      </style>
    </head>
    <body>
      <div class="container">
        <!-- 顶部导航栏 -->
        <header>
          <div class="logo">
            <i class="fas fa-chart-line"></i>
            <h1 data-i18n="system_title">Financial Asset Management System</h1>
          </div>
          <div style="display: flex; align-items: center; gap: 20px">
            <ul class="nav-tabs">
              <li>
                <a href="#" class="active" data-i18n="nav_asset">
                  Asset Management
                </a>
              </li>
              <li>
                <a href="./trades.html" data-i18n="nav_trade">Trade Management</a>
              </li>
              <li>
                <a href="./stocks.html" data-i18n="nav_stock">Stock Trading</a>
              </li>
            </ul>
            <button id="lang-toggle" style="margin-left: 20px; min-width: 60px">
              中文
            </button>
          </div>
        </header>

        <!-- 持仓管理内容 -->
        <div class="panel">
          <div class="panel-header">
            <h2 class="panel-title" data-i18n="assets_management">
              Assets Management
            </h2>
          </div>

          <!-- 持仓概览卡片 -->
          <!-- 资产概览卡片 -->
          <div class="summary-cards">
            <div class="summary-card">
              <div class="summary-card-title">
                <i class="fas fa-wallet"></i>
                <span data-i18n="total_assets">Total Assets</span>
              </div>
              <div class="summary-card-value" id="total-assets">
                $2,317,371.20
              </div>
            </div>

            <div class="summary-card">
              <div class="summary-card-title">
                <i class="fas fa-chart-line"></i>
                <span data-i18n="total_profit_loss">Total Profit/Loss</span>
              </div>
              <div class="summary-card-value positive" id="total-profit-loss">
                $63,253.45
              </div>
            </div>

            <div class="summary-card">
              <div class="summary-card-title">
                <i class="fas fa-sync"></i>
                <span data-i18n="daily_profit_loss">Daily Profit/Loss</span>
              </div>
              <div class="summary-card-value negative" id="daily-profit-loss">
                -$3,210.15
              </div>
            </div>

            <div class="summary-card">
              <div class="summary-card-title">
                <i class="fas fa-coins"></i>
                <span data-i18n="total_market_value">Total Market Value</span>
              </div>
              <div class="summary-card-value" id="total-market-value">
                $1,963,253.45
              </div>
            </div>
          </div>

          <!-- 现金流 -->
          <div class="data-section">
            <div class="cash-flow" style="display: flex; gap: 20px;">
              <div class="flow-card available-assets-card" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-top: 4px solid var(--primary);">
                <i class="fas fa-piggy-bank" style="font-size: 32px; color: var(--primary); margin-bottom: 10px;"></i>
                <div class="flow-title" data-i18n="available_assets" style="margin-bottom: 8px;">当前可用资产</div>
                <div id="available-assets-value" class="flow-value" style="color: var(--primary);">$0.00</div>
              </div>
              <div class="flow-card spending" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-top: 4px solid var(--danger);">
                <div class="flow-title" data-i18n="spending">Spending</div>
                <div class="flow-value negative" id="cash-flow-outcome">$42,500</div>
                <div class="flow-info" data-i18n="last_30_days">Last 30 Days</div>
              </div>
            </div>
            </div>
          </div>

          <!-- 持仓内容区域 -->
          <div class="positions-container">
            <!-- 持仓分布图表 -->
            <div class="distribution-chart">
              <div class="data-section">
                <div class="data-section-title" data-i18n="position_distribution">
                  Position Distribution
                </div>
                <div class="chart-container">
                  <canvas id="positionDistributionChart"></canvas>
                </div>
              </div>
            </div>

            <!-- 涨跌股列表 -->
            <div class="gainers-losers">
              <div class="gainers-container">
                <div class="section-title">
                  <i class="fas fa-arrow-up positive"></i>
                  <span data-i18n="top_gainers">Top Gainers</span>
                </div>
                <div class="gainers-list" id="gainers-list">
                  <!-- Generated by JS -->
                </div>
              </div>

              <div class="losers-container">
                <div class="section-title">
                  <i class="fas fa-arrow-down negative"></i>
                  <span data-i18n="top_losers">Top Losers</span>
                </div>
                <div class="losers-list" id="losers-list">
                  <!-- Generated by JS -->
                </div>
              </div>
            </div>

            <!-- 持仓表格 -->
            <div class="positions-table-container">
              <div class="data-section">
                <div class="data-section-title" data-i18n="position_details">
                  Position Details
                </div>
                <table class="positions-table">
                  <thead>
                    <tr>
                      <th data-i18n="stock">Stock</th>
                      <th data-i18n="cost_price">Cost Price</th>
                      <th data-i18n="current_price">Current Price</th>
                      <th data-i18n="quantity">Quantity</th>
                      <th data-i18n="daily_profit_loss">Daily Profit/Loss</th>
                      <th data-i18n="position_ratio">Position Ratio</th>
                      <th data-i18n="position_value">Position Value</th>
                    </tr>
                  </thead>
                  <tbody id="positions-table-body">
                    <!-- Generated by JS -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <script>
        // localStorage键名
        const AVAILABLE_ASSETS_KEY = 'available_assets'
        // 账户初始可用资金
        const INITIAL_CASH = 1000000
        // 资产数据对象，后续会根据positionsData动态更新
        let assetsData = {
          total_assets: INITIAL_CASH, // 总资产 = 剩余现金 + 持仓市值
          total_profit_loss: 0,      // 总盈亏
          daily_profit_loss: 0,      // 日盈亏
          total_market_value: 0,     // 总市值
          cash_flow: {
            available_assets:0, // 当前可用资产
            income: 0,               // 收入（卖出股票获得的现金，暂设为0）
            outcome: 0,              // 支出（买入股票花费的成本）
          },
        }

        // 根据positionsData动态更新assetsData
        function updateAssetsDataFromPositions() {
          // 总市值 = ∑(当前价 * 数量)
          const totalMarketValue = positionsData.reduce((sum, p) => sum + p.stock_current_price * p.quantity, 0)
          // 总盈亏 = ∑((当前价-成本价)*数量)
          const totalProfitLoss = positionsData.reduce((sum, p) => sum + (p.stock_current_price - p.stock_cost) * p.quantity, 0)
          // 日盈亏 = ∑(daily_profit_loss)
          const dailyProfitLoss = positionsData.reduce((sum, p) => sum + p.daily_profit_loss, 0)
          // 总成本 = ∑(成本价 * 数量)
          const totalCost = positionsData.reduce((sum, p) => sum + p.stock_cost * p.quantity, 0)
          // 剩余可用资金 = 初始资金 - 总成本
          const availableCash = INITIAL_CASH - totalCost
          // 总资产 = 剩余可用资金 + 总市值
          const totalAssets = availableCash + totalMarketValue
          // 支出 = 买入股票花费的成本
          const outcome = totalCost
          // 收入 = 卖出股票获得的现金（如有卖出记录可补充，这里为0）
          const income = 0

          assetsData = {
            total_assets: totalAssets,
            total_profit_loss: totalProfitLoss,
            daily_profit_loss: dailyProfitLoss,
            total_market_value: totalMarketValue,
            cash_flow: {
              available_assets:availableCash,
              income: income,
              outcome: outcome,
            },
          }
        }

        // 渲染当前可用资产
        function renderAvailableAssets() {
          // 先尝试从localStorage读取
          let value = assetsData.cash_flow.available_assets
          // 显示
          document.getElementById('available-assets-value').textContent =
            formatCurrency(value)
          // 自动保存最新值到localStorage（每次渲染都覆盖）
          localStorage.setItem(AVAILABLE_ASSETS_KEY, value)
        }

        // 持仓数据 - 初始为空，后续通过接口获取
        let positionsData = []

        // 获取持仓数据
        function fetchPositionsData() {
          fetch('http://192.168.66.103:3000/stocks/sync-position')
            .then(res => res.json())
            .then(data => {
              // 兼容后端返回的字段类型（如字符串转数字）
              positionsData = data.map(item => ({
                stock_id: item.id,
                stock_name: item.stock_name,
                stock_cost: Number(item.stock_cost),
                stock_current_price: Number(item.stock_current_price),
                quantity: Number(item.quantity),
                daily_profit_loss: Number(item.daily_profit_loss),
                position_percentage: Number(item.position_percentage) * 100, // 0.11 -> 11%
              }))
              updateAssetsDataFromPositions()
              // 刷新资产卡片
              document.getElementById('total-assets').textContent = formatCurrency(assetsData.total_assets)
              document.getElementById('total-profit-loss').textContent = formatCurrency(assetsData.total_profit_loss)
              document.getElementById('daily-profit-loss').textContent = formatCurrency(assetsData.daily_profit_loss)
              document.getElementById('total-market-value').textContent = formatCurrency(assetsData.total_market_value)
              // 刷新现金流
              // 已删除Income卡片，无需刷新
              document.getElementById('cash-flow-outcome').textContent = formatCurrency(assetsData.cash_flow.outcome)
              document.getElementById('available-assets-value').textContent = formatCurrency(assetsData.cash_flow.available_assets)
              // 刷新可用资产
              renderAvailableAssets()
              renderPositionsTable()
              renderGainersAndLosers()
              renderPositionDistributionChart()
            })
            .catch(err => {
              console.error('获取持仓数据失败', err)
            })
        }

        // 每5秒轮询localStorage.getItem('current prices')，如有则更新持仓价格
        setInterval(() => {
          const pricesStr = localStorage.getItem('current_prices')
          if (!pricesStr) return
          let prices
          try {
            prices = JSON.parse(pricesStr)
          } catch (e) {
            return
          }
          // prices应为数组或对象，支持两种格式
          // [{stockName: 'AAPL', currentPrice: 123}, ...] 或 {AAPL: 123, ...}
          let updated = false
          if (Array.isArray(prices)) {
            prices.forEach(item => {
              const p = positionsData.find(pos => pos.stock_name === item.stockName)
              if (p && typeof item.currentPrice === 'number' && p.stock_current_price !== item.currentPrice) {
                p.stock_current_price = item.currentPrice
                updated = true
              }
            })
          } else if (typeof prices === 'object' && prices !== null) {
            Object.keys(prices).forEach(name => {
              const p = positionsData.find(pos => pos.stock_name === name)
              if (p && typeof prices[name] === 'number' && p.stock_current_price !== prices[name]) {
                p.stock_current_price = prices[name]
                updated = true
              }
            })
          }
          if (updated) {
            updatePositionsData()
            // 首次渲染时不再用静态数据，等接口返回后自动刷新
            updateAssetsDataFromPositions()
            renderAvailableAssets()
            renderPositionsTable()
            renderGainersAndLosers()
            renderPositionDistributionChart()
          }
        }, 5000)
        // 获取更新后的数据
        function updatePositionsData() {
          // 上传当前所有持仓股票的名字和当前价格
          const uploadData = positionsData.map(pos => ({
            stockName: pos.stock_name,
            currentPrice: pos.stock_current_price
          }))
          fetch('http://192.168.66.103:3000/stocks/update-prices', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(uploadData)
          })
          .then(res => res.json())
          .then(data => {
            // 兼容后端返回的资产数据结构
            assetsData.total_assets = Number(data.totalAssets) || 0
            assetsData.total_market_value = Number(data.totalMarketValue) || 0
            assetsData.cash_flow.available_assets = Number(data.cashflow) || 0
            assetsData.total_profit_loss = Number(data.totalProfit) || 0
            assetsData.daily_profit_loss = Number(data.totalDailyProfit) || 0

            // 刷新资产卡片
            document.getElementById('total-assets').textContent = formatCurrency(assetsData.total_assets)
            document.getElementById('total-profit-loss').textContent = formatCurrency(assetsData.total_profit_loss)
            document.getElementById('daily-profit-loss').textContent = formatCurrency(assetsData.daily_profit_loss)
            document.getElementById('total-market-value').textContent = formatCurrency(assetsData.total_market_value)
            document.getElementById('available-assets-value').textContent = formatCurrency(assetsData.cash_flow.available_assets)
          })
          .catch(err => {
            console.error('请求失败', err)
          })
        }
        // 计算总持仓价值
        function calculateTotalPositionValue() {
          return positionsData.reduce((total, position) => {
            return total + position.stock_current_price * position.quantity
          }, 0)
        }

        // 计算总盈亏
        function calculateTotalProfitLoss() {
          return positionsData.reduce((total, position) => {
            const positionProfit =
              (position.stock_current_price - position.stock_cost) *
              position.quantity
            return total + positionProfit
          }, 0)
        }

        // 计算当日盈亏
        function calculateDailyProfitLoss() {
          return positionsData.reduce((total, position) => {
            return total + position.daily_profit_loss
          }, 0)
        }

        // 货币格式化函数
        function formatCurrency(value) {
          return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          }).format(value)
        }

        // 货币格式化函数
        function formatCurrency(value) {
          return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          }).format(value)
        }

        // 现金流计算（基于总现金流）
        function calculateCashFlow(totalCashFlow) {
          // 这里简化处理，实际项目中会有更复杂的逻辑
          const income = 18665 // 来自其他数据源
          const outcome = 42500 // 来自其他数据源
          return {
            income: income,
            outcome: outcome,
            netFlow: income - outcome,
          }
        }

        // 百分比格式化函数
        function formatPercentage(value) {
          return value.toFixed(2) + '%'
        }

        // 渲染持仓表格
        function renderPositionsTable() {
          const tableBody = document.getElementById('positions-table-body')
          tableBody.innerHTML = ''

          const totalValue = calculateTotalPositionValue()

          positionsData.forEach((position) => {
            const positionValue = position.stock_current_price * position.quantity
            const positionProfit =
              (position.stock_current_price - position.stock_cost) *
              position.quantity
            const positionProfitPercentage = (
              ((position.stock_current_price - position.stock_cost) /
                position.stock_cost) *
              100
            ).toFixed(2)

            const row = document.createElement('tr')

            row.innerHTML = `
                      <td>
                          <div class="position-details">
                              <div class="position-icon">
                                  <i class="fas fa-chart-line"></i>
                              </div>
                              <div>
                                  <div class="position-name">${
                                    position.stock_name
                                  }</div>
                                  <div class="position-ticker"></div>
                              </div>
                          </div>
                      </td>
                      <td>${formatCurrency(position.stock_cost)}</td>
                      <td>${formatCurrency(position.stock_current_price)}</td>
                      <td>${position.quantity}</td>
                      <td class="position-change ${
                        position.daily_profit_loss >= 0 ? 'positive' : 'negative'
                      }">
                          ${formatCurrency(position.daily_profit_loss)}
                      </td>
                      <td class="position-percentage">${
                        position.position_percentage
                      }%</td>
                      <td>${formatCurrency(positionValue)}</td>
                  `

            tableBody.appendChild(row)
          })
        }

        // 渲染涨跌股列表
        function renderGainersAndLosers() {
          const gainersList = document.getElementById('gainers-list')
          const losersList = document.getElementById('losers-list')

          gainersList.innerHTML = ''
          losersList.innerHTML = ''

          // 排序：按当日盈亏降序排列
          const sortedPositions = [...positionsData].sort(
            (a, b) => b.daily_profit_loss - a.daily_profit_loss
          )

          // 取前5名上涨股
          sortedPositions.slice(0, 5).forEach((position) => {
            if (position.daily_profit_loss <= 0) return

            const positionProfitPercentage = (
              ((position.stock_current_price - position.stock_cost) /
                Math.abs(position.stock_cost)) *
              100
            ).toFixed(2)

            const item = document.createElement('div')
            item.className = 'position-item'
            item.innerHTML = `
                      <div class="position-info">
                          <div class="position-item-name">${position.stock_name}</div>
                      </div>
                      <div class="position-item-change positive">+${positionProfitPercentage}%</div>
                  `

            gainersList.appendChild(item)
          })

          // 取后5名下跌股
          sortedPositions
            .slice(-5)
            .reverse()
            .forEach((position) => {
              if (position.daily_profit_loss >= 0) return

              const positionProfitPercentage = (
                ((position.stock_current_price - position.stock_cost) /
                  position.stock_cost) *
                100
              ).toFixed(2)

              const item = document.createElement('div')
              item.className = 'position-item'
              item.innerHTML = `
                      <div class="position-info">
                          <div class="position-item-name">${position.stock_name}</div>
                          <div class="position-item-ticker">ID: ${position.stock_id}</div>
                      </div>
                      <div class="position-item-change negative">${positionProfitPercentage}%</div>
                  `

              losersList.appendChild(item)
            })
        }

        // 渲染持仓分布图表
        function renderPositionDistributionChart() {
          const ctx = document
            .getElementById('positionDistributionChart')
            .getContext('2d')

          // 准备图表数据
          const labels = positionsData.map((p) => p.stock_name)
          const data = positionsData.map((p) => p.position_percentage)
          const backgroundColors = [
            '#3b82f6',
            '#10b981',
            '#f59e0b',
            '#ef4444',
            '#8b5cf6',
            '#06b6d4',
            '#f97316',
            '#ec4899',
            '#a855f7',
            '#64748b',
          ]

          new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: labels,
              datasets: [
                {
                  data: data,
                  backgroundColor: backgroundColors,
                  borderWidth: 0,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'right',
                  labels: {
                    boxWidth: 12,
                    padding: 15,
                    font: {
                      size: 12,
                    },
                  },
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      return `${context.label}: ${context.parsed}%`
                    },
                  },
                },
              },
              cutout: '60%',
            },
          })
        }

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function () {
          // 获取并渲染持仓数据
          fetchPositionsData()
        })
      </script>
    </body>
  </html>
